import React, { useState, useRef } from 'react';
import { Download, Copy, Trash2 } from 'lucide-react';

export default function QRCodeGenerator() {
  const [qrType, setQrType] = useState('website');
  const [mainInput, setMainInput] = useState('https://github.com');
  const [qrColor, setQrColor] = useState('#000000');
  const [bgColor, setBgColor] = useState('#ffffff');
  const [history, setHistory] = useState([]);
  const [message, setMessage] = useState('');
  const [qrCode, setQrCode] = useState(null);
  const qrRef = useRef();
  const [wifiSSID, setWifiSSID] = useState('');
  const [wifiPassword, setWifiPassword] = useState('');
  const [batchText, setBatchText] = useState('');

  // Import QRCode from CDN
  React.useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js';
    script.async = true;
    document.body.appendChild(script);
    return () => {
      document.body.removeChild(script);
    };
  }, []);

  const detectInputType = (input) => {
    input = input.trim();
    
    if (input.startsWith('http://') || input.startsWith('https://')) {
      return { data: input, type: 'website' };
    }
    if (input.startsWith('www.')) {
      return { data: `https://${input}`, type: 'website' };
    }
    const domainPattern = /^[a-zA-Z0-9][a-zA-Z0-9.-]*\.[a-zA-Z]{2,}$/;
    if (domainPattern.test(input)) {
      return { data: `https://${input}`, type: 'website' };
    }
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (emailPattern.test(input)) {
      return { data: `mailto:${input}`, type: 'email' };
    }
    const phonePattern = /^[\+]?[0-9\s\-\(\)]{10,}$/;
    if (phonePattern.test(input)) {
      const clean = input.replace(/[\s\-\(\)]/g, '');
      return { data: `tel:${clean}`, type: 'phone' };
    }
    return { data: input, type: 'text' };
  };

  const generateQR = () => {
    try {
      if (!window.QRCode) {
        showMsg('QRCode library loading...', 'info');
        return;
      }

      let qrData = '';
      let inputType = '';

      if (qrType === 'wifi') {
        if (!wifiSSID) {
          showMsg('Please enter WiFi SSID', 'error');
          return;
        }
        qrData = `WIFI:S:${wifiSSID};T:WPA;P:${wifiPassword};;`;
        inputType = 'wifi';
      } else {
        if (!mainInput) {
          showMsg('Please enter content', 'error');
          return;
        }
        const result = detectInputType(mainInput);
        qrData = result.data;
        inputType = result.type;
      }

      // Clear previous QR
      if (qrRef.current) {
        qrRef.current.innerHTML = '';
      }

      // Generate new QR
      const qr = new window.QRCode(qrRef.current, {
        text: qrData,
        width: 350,
        height: 350,
        colorDark: qrColor,
        colorLight: bgColor,
        correctLevel: window.QRCode.CorrectLevel.H,
      });

      setQrCode({ data: qrData, type: inputType });
      addToHistory(qrData, inputType);
      showMsg(`âœ“ QR Code generated! Type: ${inputType}`, 'success');
    } catch (error) {
      showMsg(`Error: ${error.message}`, 'error');
    }
  };

  const showMsg = (msg, type) => {
    setMessage({ text: msg, type });
    setTimeout(() => setMessage(''), 3000);
  };

  const addToHistory = (data, type) => {
    setHistory(prev => [{ data, type, time: new Date().toLocaleTimeString() }, ...prev].slice(0, 10));
  };

  const downloadQR = () => {
    const canvas = qrRef.current?.querySelector('canvas');
    if (canvas) {
      const link = document.createElement('a');
      link.download = 'qrcode.png';
      link.href = canvas.toDataURL();
      link.click();
      showMsg('âœ“ Downloaded!', 'success');
    }
  };

  const batchGenerate = () => {
    const items = batchText.split('\n').filter(i => i.trim());
    if (items.length === 0) {
      showMsg('Enter items separated by new lines', 'error');
      return;
    }
    showMsg(`Generated ${items.length} QR codes!`, 'success');
  };

  const loadHistory = (item) => {
    setMainInput(item.data);
    generateQR();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-500 to-purple-700 p-4">
      <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 text-center">
          <h1 className="text-3xl font-bold mb-2">ðŸŽ¯ QR Code Generator</h1>
          <p className="opacity-90">Create QR codes from websites, emails, and more</p>
        </div>

        {/* Message */}
        {message && (
          <div className={`p-3 mx-4 mt-4 rounded ${message.type === 'error' ? 'bg-red-100 text-red-700' : message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
            {message.text}
          </div>
        )}

        <div className="p-6">
          {/* Tabs */}
          <div className="flex gap-2 mb-6">
            <button className="px-4 py-2 bg-green-500 text-white rounded font-semibold">Generator</button>
            <button className="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">History</button>
            <button className="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Batch</button>
          </div>

          {/* Type Selection */}
          <div className="mb-4">
            <label className="block text-sm font-semibold mb-2">Select Type:</label>
            <div className="grid grid-cols-3 gap-2">
              {['website', 'email', 'phone', 'text', 'wifi'].map(type => (
                <button
                  key={type}
                  onClick={() => setQrType(type)}
                  className={`py-2 px-3 rounded font-semibold text-sm transition ${
                    qrType === type ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  {type.toUpperCase()}
                </button>
              ))}
            </div>
          </div>

          {/* Main Input */}
          {qrType !== 'wifi' && (
            <div className="mb-4">
              <label className="block text-sm font-semibold mb-2">Content:</label>
              <input
                type="text"
                value={mainInput}
                onChange={(e) => setMainInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && generateQR()}
                placeholder="Enter website, email, or phone..."
                className="w-full p-3 border-2 border-gray-300 rounded focus:border-green-500 focus:outline-none"
              />
            </div>
          )}

          {/* WiFi Inputs */}
          {qrType === 'wifi' && (
            <div className="mb-4 bg-gray-100 p-4 rounded border-l-4 border-green-500">
              <div className="mb-3">
                <label className="block text-sm font-semibold mb-2">WiFi SSID:</label>
                <input
                  type="text"
                  value={wifiSSID}
                  onChange={(e) => setWifiSSID(e.target.value)}
                  placeholder="Enter network name"
                  className="w-full p-2 border-2 border-gray-300 rounded focus:border-green-500 focus:outline-none"
                />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2">Password:</label>
                <input
                  type="text"
                  value={wifiPassword}
                  onChange={(e) => setWifiPassword(e.target.value)}
                  placeholder="Enter password"
                  className="w-full p-2 border-2 border-gray-300 rounded focus:border-green-500 focus:outline-none"
                />
              </div>
            </div>
          )}

          {/* Colors */}
          <div className="mb-4 bg-gray-100 p-4 rounded">
            <label className="block text-sm font-semibold mb-3">Customize Colors:</label>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-xs font-semibold">QR Color:</label>
                <input
                  type="color"
                  value={qrColor}
                  onChange={(e) => setQrColor(e.target.value)}
                  className="w-full h-10 border-2 border-gray-300 rounded cursor-pointer"
                />
              </div>
              <div>
                <label className="text-xs font-semibold">Background:</label>
                <input
                  type="color"
                  value={bgColor}
                  onChange={(e) => setBgColor(e.target.value)}
                  className="w-full h-10 border-2 border-gray-300 rounded cursor-pointer"
                />
              </div>
            </div>
          </div>

          {/* Buttons */}
          <div className="grid grid-cols-2 gap-3 mb-6">
            <button
              onClick={generateQR}
              className="bg-green-500 text-white font-semibold py-3 rounded hover:bg-green-600 transition"
            >
              ðŸš€ Generate QR
            </button>
            <button
              onClick={downloadQR}
              className="bg-blue-500 text-white font-semibold py-3 rounded hover:bg-blue-600 transition flex items-center justify-center gap-2"
            >
              <Download size={18} /> Download
            </button>
          </div>

          {/* QR Preview */}
          <div className="bg-gray-100 p-6 rounded text-center border-2 border-dashed border-gray-300">
            <div ref={qrRef} className="flex justify-center">
              <p className="text-gray-500">QR code will appear here</p>
            </div>
          </div>

          {/* History */}
          {history.length > 0 && (
            <div className="mt-6">
              <h3 className="font-semibold mb-2">ðŸ“š Recent QR Codes:</h3>
              <div className="bg-gray-50 rounded max-h-48 overflow-y-auto">
                {history.map((item, idx) => (
                  <div
                    key={idx}
                    onClick={() => loadHistory(item)}
                    className="p-3 border-b cursor-pointer hover:bg-gray-100 transition"
                  >
                    <strong className="text-green-600">{item.type.toUpperCase()}</strong>
                    <p className="text-sm text-gray-600">{item.data.substring(0, 50)}</p>
                    <p className="text-xs text-gray-400">{item.time}</p>
                  </div>
                ))}
              </div>
              <button
                onClick={() => setHistory([])}
                className="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold flex items-center gap-1"
              >
                <Trash2 size={16} /> Clear History
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
